Object.defineProperty(exports, "__esModule", { value: true });
exports.BreakpadUploader = void 0;
const tslib_1 = require("tslib");
const utils_1 = require("@sentry/utils");
const path_1 = require("path");
const electron_normalize_1 = require("../../electron-normalize");
const fs_1 = require("../../fs");
const base_uploader_1 = require("./base-uploader");
/** */
class BreakpadUploader extends base_uploader_1.BaseUploader {
    constructor(options, transport) {
        super(options, transport);
        this._crashesDirectory = (0, electron_normalize_1.getCrashesDirectory)();
    }
    /** @inheritdoc */
    _getMinidumpPaths() {
        return (0, tslib_1.__awaiter)(this, void 0, void 0, function* () {
            // Breakpad stores all minidump files along with a metadata file directly in
            // the crashes directory.
            const files = yield (0, fs_1.readDirAsync)(this._crashesDirectory);
            // Remove all metadata files and forget about them.
            // eslint-disable-next-line @typescript-eslint/no-floating-promises
            Promise.all(files
                .filter((file) => file.endsWith('.txt') && !file.endsWith('log.txt'))
                .map((file) => (0, tslib_1.__awaiter)(this, void 0, void 0, function* () {
                const path = (0, path_1.join)(this._crashesDirectory, file);
                try {
                    yield (0, fs_1.unlinkAsync)(path);
                }
                catch (e) {
                    utils_1.logger.warn('Could not delete', path);
                }
            })));
            return files.filter((file) => file.endsWith('.dmp')).map((file) => (0, path_1.join)(this._crashesDirectory, file));
        });
    }
    /** Crudely parses the dump file from the Breakpad multipart file */
    _preProcessFile(file) {
        const binaryStart = file.lastIndexOf('Content-Type: application/octet-stream');
        if (binaryStart > 0) {
            const dumpStart = file.indexOf('MDMP', binaryStart);
            const dumpEnd = file.lastIndexOf('----------------------------');
            if (dumpStart > 0 && dumpEnd > 0 && dumpEnd > dumpStart) {
                return file.slice(dumpStart, dumpEnd);
            }
        }
        return undefined;
    }
}
exports.BreakpadUploader = BreakpadUploader;
//# sourceMappingURL=breakpad-uploader.js.map