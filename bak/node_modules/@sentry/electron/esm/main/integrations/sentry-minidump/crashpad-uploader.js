import { __awaiter } from "tslib";
import { forget, logger } from '@sentry/utils';
import { join } from 'path';
import { getCrashesDirectory } from '../../electron-normalize';
import { readDirAsync, unlinkAsync } from '../../fs';
import { BaseUploader } from './base-uploader';
/** */
export class CrashpadUploader extends BaseUploader {
    constructor(options, transport) {
        super(options, transport);
        this._crashesDirectory = getCrashesDirectory();
        this._crashpadSubDirectory = process.platform === 'win32' ? 'reports' : 'completed';
    }
    /** @inheritdoc */
    _getMinidumpPaths() {
        return __awaiter(this, void 0, void 0, function* () {
            forget(this._deleteCrashpadMetadataFile());
            // Crashpad moves minidump files directly into the 'completed' or 'reports' folder. We can
            // load them from there, upload to the server, and then delete them.
            const dumpDirectory = join(this._crashesDirectory, this._crashpadSubDirectory);
            const files = yield readDirAsync(dumpDirectory);
            return files.filter((file) => file.endsWith('.dmp')).map((file) => join(dumpDirectory, file));
        });
    }
    /** @inheritdoc */
    _preProcessFile(file) {
        return file;
    }
    /** Attempts to remove the metadata file so Crashpad doesn't output `failed to stat report` errors to the console */
    _deleteCrashpadMetadataFile(waitMs = 100) {
        return __awaiter(this, void 0, void 0, function* () {
            if (waitMs > 2000) {
                return;
            }
            const metadataPath = join(this._crashesDirectory, 'metadata');
            try {
                yield unlinkAsync(metadataPath);
                logger.log('Deleted Crashpad metadata file', metadataPath);
            }
            catch (e) {
                // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access
                if (e.code && e.code == 'EBUSY') {
                    // Since Crashpad probably still has the metadata file open, we make a few attempts to delete it, backing
                    // off and waiting longer each time.
                    setTimeout(() => __awaiter(this, void 0, void 0, function* () {
                        yield this._deleteCrashpadMetadataFile(waitMs * 2);
                    }), waitMs);
                }
            }
        });
    }
}
//# sourceMappingURL=crashpad-uploader.js.map